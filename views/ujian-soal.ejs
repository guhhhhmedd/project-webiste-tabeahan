<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <title>Ujian CAT</title>
     <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <style>
        .hidden {
            display: none;
        }

        .nav-item.answered {
            background-color: #d72323;
            color: white;
        }

        .nav-item.active {
            border: 2px solid #4a3721;
            font-weight: bold;
            color: #4a3721;
        }
    </style>
</head>

<body class="bg-slate-100 p-4 md:p-8">
    <div id="exam-data" data-total="<%= soal.length %>" data-start="<%= waktuMulai %>" class="hidden"></div>

    <div class="max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-4 gap-6">
        <div class="lg:col-span-3 bg-white p-6 rounded-xl shadow">
            <div class="flex justify-between border-b pb-4 mb-6">
                <h2 id="timer" class="text-2xl font-mono font-bold text-red-600">00:00:00</h2>
                <span class="font-bold text-slate-700 uppercase">
                    <%= user.username %>
                </span>
            </div>

            <div id="soal-container">
                <% soal.forEach((s, index)=> { %>
                    <div id="box-<%= index %>" class="soal-box hidden">
                        <p class="text-sm text-slate-400 mb-2 uppercase">Soal Ke-<%= index + 1 %> | <%= s.materi %>
                        </p>
                        <p class="text-lg font-medium mb-6">
                            <%= s.soal %>
                        </p>
                        <div class="space-y-3">
                            <% ['a','b','c','d','e'].forEach(opt=> { %>
                                <label class="block p-4 border rounded-lg hover:bg-slate-50 cursor-pointer transition">
                                    <input type="radio" name="q_<%= s.id %>" value="<%= opt %>" class="jawaban-radio"
                                        data-qid="<%= s.id %>" data-idx="<%= index %>">
                                    <span class="ml-2 uppercase font-bold text-slate-700">
                                        <%= opt %>. <%= s['opsi_'+opt] %>
                                    </span>
                                </label>
                                <% }) %>
                        </div>
                    </div>
                    <% }) %>
            </div>

            <div class="flex justify-between mt-8 border-t pt-4">
                <button onclick="navSoal(-1)"
                    class="bg-slate-200 px-6 py-2 rounded font-bold hover:bg-slate-300">KEMBALI</button>
                <button onclick="navSoal(1)"
                    class="bg-[#4a3721] text-white px-6 py-2 rounded font-bold hover:bg-black transition">LANJUT</button>
            </div>
        </div>

        <div class="bg-white p-4 rounded-xl shadow h-fit">
            <div class="grid grid-cols-5 gap-2">
                <% soal.forEach((s, index)=> { %>
                    <button id="nav-<%= index %>" onclick="lompat(<%= index %>)"
                        class="nav-item w-10 h-10 border rounded text-xs text-slate-400">
                        <%= index + 1 %>
                    </button>
                    <% }) %>
            </div>
            <button onclick="selesaiUjian()"
                class="w-full mt-6 bg-red-600 text-white py-3 rounded font-bold hover:bg-red-700 transition">AKHIRI
                UJIAN</button>
        </div>
    </div>

    <script>
        const examMeta = document.getElementById('exam-data').dataset;
        const totalSoal = parseInt(examMeta.total);

        // --- LOGIKA WAKTU (Anti-NaN) ---
        const startTime = Number(examMeta.start);
        const durasiMenit = 60;
        const endTime = startTime + (durasiMenit * 60 * 1000);
        // console.log("Waktu Start (Timestamp):", startTime);

        let currentIdx = 0;

        function updateView() {
            document.querySelectorAll('.soal-box').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active', 'border-2', 'border-black', 'ring-2', 'ring-yellow-400'));

            const currentBox = document.getElementById(`box-${currentIdx}`);
            const currentNav = document.getElementById(`nav-${currentIdx}`);

            if (currentBox) currentBox.classList.remove('hidden');
            if (currentNav) {
                currentNav.classList.add('active', 'ring-2', 'ring-yellow-400');
                currentNav.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }

        function navSoal(step) {
            let n = currentIdx + step;
            if (n >= 0 && n < totalSoal) {
                currentIdx = n;
                updateView();
            }
        }

        function lompat(idx) {
            currentIdx = parseInt(idx);
            updateView();
        }

        // --- LOGIKA TIMER HITUNG MUNDUR ---
        const timerLabel = document.getElementById('timer');
        const timerInterval = setInterval(() => {
            const now = new Date().getTime();
            const diff = endTime - now;

            if (diff <= 0) {
                clearInterval(timerInterval);
                timerLabel.innerText = "00:00";
                alert("Waktu Habis! Jawaban Anda akan dikirim otomatis.");
                processSelesai();
                return;
            }

            const m = Math.floor((diff / (1000 * 60)) % 60);
            const s = Math.floor((diff / 1000) % 60);

            // Tampilkan Menit:Detik (Contoh: 59:05)
            timerLabel.innerText = `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;

            // Efek merah kedip kalau sisa 5 menit
            if (diff < 300000) {
                timerLabel.classList.add('animate-pulse', 'text-red-500');
            }
        }, 1000);

        // --- SIMPAN JAWABAN REAL-TIME ---
        document.querySelectorAll('.jawaban-radio').forEach(radio => {
            radio.addEventListener('change', function () {
                const qId = this.dataset.qid;
                const jaw = this.value;
                const idx = this.dataset.idx;

                // Beri warna di nomor navigasi kalau sudah dijawab
                const navBtn = document.getElementById(`nav-${idx}`);
                if (navBtn) {
                    navBtn.classList.add('answered', 'bg-[#b8924a]', 'text-white');
                }

                fetch('/ujian/simpan-jawaban', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ questionId: qId, jawaban: jaw })
                }).catch(err => {
                    console.error("Gagal simpan:", err);
                });
            });
        });

        function processSelesai() {
            fetch('/ujian/selesai', { method: 'POST' })
                .then(() => { window.location.href = "/dashboard"; })
                .catch(() => { window.location.href = "/dashboard"; });
        }

        updateView();


        // 1. Matikan Klik Kanan
        document.addEventListener('contextmenu', event => event.preventDefault());
        document.onkeydown = function (e) {
            if (e.keyCode == 123) return false;
            // Ctrl+Shift+I (Inspect)
            if (e.ctrlKey && e.shiftKey && e.keyCode == 'I'.charCodeAt(0)) return false;
            // Ctrl+Shift+J (Console)
            if (e.ctrlKey && e.shiftKey && e.keyCode == 'J'.charCodeAt(0)) return false;
            // Ctrl+U (View Source)
            if (e.ctrlKey && e.keyCode == 'U'.charCodeAt(0)) return false;
            // Ctrl+S (Save Page)
            if (e.ctrlKey && e.keyCode == 'S'.charCodeAt(0)) return false;
            // Ctrl+C (Copy) - Biar soal gak bisa dicontek ke luar
            if (e.ctrlKey && e.keyCode == 'C'.charCodeAt(0)) return false;
        };

        let violationCount = 0;

        document.addEventListener("visibilitychange", function () {
            if (document.visibilityState === 'hidden') {
                violationCount++;

                if (violationCount >= 2) {
                    alert("PELANGGARAN KERAS! Kamu sudah 2 kali pindah tab. Ujian otomatis DIHENTIKAN!");
                    processSelesai();
                } else {
                    alert("PERINGATAN! Jangan pindah tab atau membuka aplikasi lain. Satu kali lagi, ujianmu hangus!");
                }
            }
        });

    </script>
</body>

</html>