<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Ujian CAT - <%= paket %></title>
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
  <style>
    .soal-box.hidden { display: none; }
    .nav-item { width: 2.5rem; height: 2.5rem; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 0.75rem; color: #94a3b8; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.15s; }
    .nav-item:hover { background: #f8fafc; }
    .nav-item.answered { background-color: #b8924a; color: white; border-color: #b8924a; }
    .nav-item.active { border: 2px solid #4a3721; font-weight: bold; color: #4a3721; box-shadow: 0 0 0 2px rgba(234,179,8,0.4); }
    .nav-item.answered.active { background-color: #b8924a; color: white; border: 2px solid #4a3721; }
  </style>
</head>
<body class="bg-slate-100 p-4 md:p-8">

  <%# Data untuk JS — pakai JSON agar aman, hindari XSS %>
  <div id="exam-data"
    data-total="<%= soal.length %>"
    data-start="<%= waktuMulai %>"
    data-durasi="<%= durasiMs %>"
    class="hidden">
  </div>

  <%# Jawaban yang sudah diisi sebelumnya (untuk restore setelah refresh) %>
  <script id="existing-jawaban" type="application/json">
    <%- JSON.stringify(jawaban || {}) %>
  </script>

  <div class="max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-4 gap-6">

    <!-- ===== AREA SOAL ===== -->
    <div class="lg:col-span-3 bg-white p-6 rounded-xl shadow">
      <div class="flex justify-between items-center border-b pb-4 mb-6">
        <div>
          <h2 id="timer" class="text-2xl font-mono font-bold text-red-600">00:00</h2>
          <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest mt-0.5"><%= paket %></p>
        </div>
        <span class="font-bold text-slate-700 uppercase text-sm"><%= user.username %></span>
      </div>

      <!-- Semua soal dirender, toggle visibility via JS -->
      <div id="soal-container">
        <% soal.forEach((s, index) => { %>
        <div id="box-<%= index %>" class="soal-box hidden">
          <p class="text-xs text-slate-400 mb-2 uppercase font-bold tracking-wide">
            Soal ke-<%= index + 1 %> dari <%= soal.length %> &nbsp;|&nbsp; <%= s.materi %>
          </p>
          <p class="text-base md:text-lg font-medium mb-6 leading-relaxed"><%= s.soal %></p>
          <div class="space-y-3">
            <% ['a','b','c','d','e'].forEach(opt => { %>
              <% if (s['opsi_' + opt]) { %>
              <label class="flex items-start gap-3 p-4 border rounded-xl hover:bg-slate-50 cursor-pointer transition select-none">
                <input type="radio"
                  name="q_<%= s.id %>"
                  value="<%= opt %>"
                  class="jawaban-radio mt-0.5 accent-[#b8924a]"
                  data-qid="<%= s.id %>"
                  data-idx="<%= index %>">
                <span class="text-sm font-medium text-slate-700">
                  <span class="font-black uppercase text-[#4a3721]"><%= opt %>.</span>
                  <%= s['opsi_' + opt] %>
                </span>
              </label>
              <% } %>
            <% }) %>
          </div>
        </div>
        <% }) %>
      </div>

      <!-- Navigasi bawah -->
      <div class="flex justify-between mt-8 border-t pt-4">
        <button id="btnKembali" class="bg-slate-200 px-6 py-2 rounded-lg font-bold hover:bg-slate-300 transition text-sm">← Kembali</button>
        <button id="btnLanjut" class="bg-[#4a3721] text-white px-6 py-2 rounded-lg font-bold hover:bg-black transition text-sm">Lanjut →</button>
      </div>
    </div>

    <!-- ===== PANEL NAVIGASI ===== -->
    <div class="bg-white p-4 rounded-xl shadow h-fit sticky top-4">
      <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-3">Nomor Soal</p>
      <div class="grid grid-cols-5 gap-1.5" id="nav-grid">
        <% soal.forEach((s, index) => { %>
        <button class="nav-item" data-index="<%= index %>"><%= index + 1 %></button>
        <% }) %>
      </div>
      <div class="mt-4 flex gap-2 text-[10px]">
        <span class="flex items-center gap-1"><span class="w-3 h-3 rounded bg-[#b8924a] inline-block"></span> Dijawab</span>
        <span class="flex items-center gap-1"><span class="w-3 h-3 rounded border-2 border-[#4a3721] inline-block"></span> Aktif</span>
      </div>
      <button id="btnSelesai" class="w-full mt-6 bg-red-600 text-white py-3 rounded-lg font-bold hover:bg-red-700 transition text-sm">
        AKHIRI UJIAN
      </button>
    </div>
  </div>

  <script>
    // ── Data dari server ──
    const examData    = document.getElementById('exam-data').dataset;
    const totalSoal   = parseInt(examData.total);
    const startTime   = Number(examData.start);
    const durasiMs    = Number(examData.durasi);
    const endTime     = startTime + durasiMs;

    // Jawaban yang sudah diisi sebelumnya (restore setelah refresh)
    let jawabanMap = {};
    try {
      jawabanMap = JSON.parse(document.getElementById('existing-jawaban').textContent);
    } catch(e) {}

    let currentIdx = 0;

    // ── Restore jawaban yang sudah diisi ──
    function restoreJawaban() {
      Object.entries(jawabanMap).forEach(([qid, jawaban]) => {
        const radio = document.querySelector(`input[name="q_${qid}"][value="${jawaban}"]`);
        if (radio) {
          radio.checked = true;
          const idx = parseInt(radio.dataset.idx);
          markAnswered(idx);
        }
      });
    }

    function markAnswered(idx) {
      const navBtn = document.querySelector(`.nav-item[data-index="${idx}"]`);
      if (navBtn) navBtn.classList.add('answered');
    }

    // ── Navigasi soal ──
    function updateView() {
      document.querySelectorAll('.soal-box').forEach(el => el.classList.add('hidden'));
      document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));

      const box = document.getElementById(`box-${currentIdx}`);
      const nav = document.querySelector(`.nav-item[data-index="${currentIdx}"]`);
      if (box) box.classList.remove('hidden');
      if (nav) {
        nav.classList.add('active');
        nav.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      }

      document.getElementById('btnKembali').disabled = currentIdx === 0;
      document.getElementById('btnLanjut').disabled  = currentIdx === totalSoal - 1;
    }

    document.getElementById('btnKembali').addEventListener('click', () => {
      if (currentIdx > 0) { currentIdx--; updateView(); }
    });

    document.getElementById('btnLanjut').addEventListener('click', () => {
      if (currentIdx < totalSoal - 1) { currentIdx++; updateView(); }
    });

    document.getElementById('nav-grid').addEventListener('click', e => {
      const btn = e.target.closest('.nav-item');
      if (!btn) return;
      currentIdx = parseInt(btn.dataset.index);
      updateView();
    });

    // ── Simpan jawaban ke session via fetch ──
    document.querySelectorAll('.jawaban-radio').forEach(radio => {
      radio.addEventListener('change', function() {
        const qId  = this.dataset.qid;
        const jaw  = this.value;
        const idx  = parseInt(this.dataset.idx);

        jawabanMap[qId] = jaw;
        markAnswered(idx);

        fetch('/ujian/simpan-jawaban', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ questionId: qId, jawaban: jaw })
        })
        .then(r => r.json())
        .then(data => {
          if (data.expired) {
            alert('Waktu ujian sudah habis!');
            window.location.href = '/ujian/selesai-paksa';
          }
        })
        .catch(err => console.error("Gagal simpan jawaban:", err));
      });
    });

    // ── Timer hitung mundur ──
    const timerEl = document.getElementById('timer');
    const timerInterval = setInterval(() => {
      const diff = endTime - Date.now();
      if (diff <= 0) {
        clearInterval(timerInterval);
        timerEl.textContent = "00:00";
        alert("Waktu habis! Jawaban Anda dikirim otomatis.");
        submitSelesai();
        return;
      }
      const h = Math.floor(diff / (1000 * 60 * 60));
      const m = Math.floor((diff / (1000 * 60)) % 60);
      const s = Math.floor((diff / 1000) % 60);
      timerEl.textContent = h > 0
        ? `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`
        : `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;

      if (diff < 300000) timerEl.classList.add('animate-pulse', 'text-red-500');
    }, 1000);

    // ── Submit selesai (fetch → redirect) ──
    function submitSelesai() {
      clearInterval(timerInterval);
      fetch('/ujian/selesai', { method: 'POST' })
        .then(r => r.json())
        .then(data => { window.location.href = data.redirect || '/users/dashboardPembayaranUjian'; })
        .catch(() => { window.location.href = '/users/dashboardPembayaranUjian'; });
    }

    document.getElementById('btnSelesai').addEventListener('click', () => {
      const dijawab = Object.keys(jawabanMap).length;
      const belum = totalSoal - dijawab;
      const msg = belum > 0
        ? `Masih ada ${belum} soal belum dijawab. Akhiri ujian sekarang?`
        : 'Semua soal sudah dijawab. Akhiri ujian sekarang?';
      if (confirm(msg)) submitSelesai();
    });

    // ── Keamanan ──
    document.addEventListener('contextmenu', e => e.preventDefault());
    document.addEventListener('keydown', e => {
      if (e.key === 'F12') { e.preventDefault(); return false; }
      if (e.ctrlKey && e.shiftKey && ['I','J','C'].includes(e.key.toUpperCase())) { e.preventDefault(); return false; }
      if (e.ctrlKey && ['U','S'].includes(e.key.toUpperCase())) { e.preventDefault(); return false; }
    });

    let violationCount = 0;
    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'hidden') {
        violationCount++;
        if (violationCount >= 2) {
          alert('PELANGGARAN! Kamu sudah 2x pindah tab. Ujian dihentikan otomatis!');
          submitSelesai();
        } else {
          alert('PERINGATAN! Jangan pindah tab. Sekali lagi, ujianmu hangus!');
        }
      }
    });

    // ── Init ──
    restoreJawaban();
    updateView();
  </script>
</body>
</html>
